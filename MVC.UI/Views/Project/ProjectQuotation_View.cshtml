@{
    ViewBag.Title = "审批中的协议";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<body>
    <div class="easyui-layout" data-options="fit:true" id="tb_Quotation">
        <!-------------------------------搜索框----------------------------------->
        <!------------------------------------------------------------------------>
        <div data-options="region:'center'">
            <!-------------------------------详细信息展示表格----------------------------------->
            <table id="Quotation_dgrid" class="easyui-datagrid" fit="true" data-options="
               rownumbers:true,
               pagination:true,
               pagenumber:1,
               pageSize:pageSize,
               pageList:pageList,

               remoteSort:true,
               sortName:'AgreeIndex',
               sortOrder:'asc',
               singleSelect:true,
               nowrap:false,
               loadMsg: loadMsg,
               striped : true,
               fitColumns:true,
               method:'post',
               view: detailview,
              detailFormatter:QuotationdetailFormatter,
              onExpandRow:Quotationdetail_onExpandRow
            ">
                <thead>
                    <tr>

                        <th data-options="field:'_operate',width:80,align:'center',formatter:OperationQuotaion">{{Operation}}</th>
                        <th data-options=" field:'AgreeNo',width:90,sortable:false">{{AgreeNo}}</th>
                        <th data-options=" field:'AgreeName',width:90,sortable:false">{{QuotationName}}</th>
                        <th data-options=" field:'CostTotal',width:60,sortable:false">Total Cost</th>
                        <th data-options=" field:'PriceTotal',width:60,sortable:false">Total Price</th>
                        <th data-options=" field:'Discount',width:60,sortable:false">Discount</th>
                        <th data-options=" field:'Gst',width:60,sortable:false">Gst(%)</th>
                        <th data-options=" field:'GstTotal',width:60,sortable:false">Gst Value</th>
                        <th data-options=" field:'GrandTotal',width:60,sortable:false">Grand Total</th>

                        <th data-options=" field:'Remark',width:90,sortable:false">{{Remark}}</th>
                        <th data-options=" field:'AgreeDate',width:90,sortable:false,formatter:AgreeDateFormatter">{{ModifiedDate}}</th>
                    </tr>
                </thead>
            </table>
            <!-------------------------------详细信息展示表格----------------------------------->
        </div>
    </div>
    <!-------------------------------操作按钮----------------------------------->
    <div id="Quotation_toolbar" style="height:auto">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-reload',plain:true" onclick="Reload('#Quotation_dgrid');">{{Reload}}</a>

    </div>


    <script>
        var vm_Quotationgridhead = new Vue({
            el: '#Quotation_dgrid',
            data: {
                Condition: $lang("Search Condition"),
                Operation: $setLang("Operation", "操作"),
                Search: $lang("Search"),
                AgreeNo: $setLang("Agreement No", "协议号"),
                QuotationName: $setLang("Quotation Name", "报价名称"),
                Remark: $setLang("Remark", "备注"),
                Type: $setLang("Type", "类型"),
                Total: $setLang("Total", "金额"),
                Approval: $setLang("Approval User", "审批人"),
                ModifiedDate: $setLang("Modified Date", "修改日期"),

                Category: $setLang("Category", "分类"),
                Description: $setLang("Description", "描述"),
                CostMarkup: $setLang("Cost Markup(%)", "盈利(%)"),
                Uom: $setLang("Uom", "单位"),
                Cost: $setLang("Cost", "成本"),
                Price: $setLang("Price", "单价"),
                Qty: $setLang("Qty", "数量"),
                TotalCost: $setLang("Total Cost", "总成本"),
                TotalPrice: $setLang("Total Price", "总价格"),

            }
        })

        //toolbar按钮
        var vm_Quotationtoolbar = new Vue({
            el: '#Quotation_toolbar',
            data: {
                Add: $lang("Add"),
                Edit: $lang("Edit"),
                Delete: $lang("Delete"),
                Quotation:$setLang("Quotation", "协议"),
                Reload: $setLang("Reload", "刷新"),
                Operation: $setLang("Operation", "操作"),
                Agree: $setLang("Agree", "同意"),
                Resubmit: $setLang("Resubmit", "撤回")
            }
        })
        //增加修改模态框
        var vm_Quotationdialog = new Vue({
            el: '#dlg_addDialog_Quotation',
            data: {
                title: $lang("Basic Information"),
                AgreeNo: $setLang("Agreement No", "协议号"),
                QuotationName: $setLang("Quotation Name", "报价名称"),
                Remark: $setLang("Remark", "备注"),
                Type: $setLang("Type", "类型"),
                Total: $setLang("Total", "金额"),
                Approval: $setLang("Approval User", "审批人"),
            }
        })
        //
         //Agree模态框
        var vm_dlg_Dialog_Agree = new Vue({
            el: '#dlg_Dialog_Agree',
            data: {
                title: $lang("Basic Information"),
                TotalPrice: $setLang("Total Price", "总金额"),
                Discount: $setLang("Discount", "优惠"),
                GST: $setLang("GST(%)", "税(%)"),
                GSTAmount: $setLang("GST Amount", "税额"),
                GrandTotal: $setLang("Total", "金额"),
                 NeedPay: $setLang("Need Pay", "需付款"),
                 AgreeTotalPrice_value: 0,
                AgreeDiscount_value: 0,
                AgreeGST_value: 0,
                AgreeGSTAmount_value: 0,
                GrandTotal_value: 0,
                NeedPay_value:0,
            },
            methods: {},
            watch: {

            },
            computed: {
            }
        })


    </script>
    <script>
        var projectId=@ViewBag.projectId;

    $("#Quotation_dgrid").datagrid({
        url: '/Project/ApprovalsProjectSearch',
        queryParams: {
            'projectId': projectId,
        },
    });

    //-------------------------------------------------------------------------


    //其它方法****************************
    function StatusFormatter(value, row, index) {
        var str = "Quotation";
        if (value == "1")
            str = "Agreement";
        return str;
    }
    function AgreeDateFormatter(value, row, index) {
        var str = "";
        if (value != null)
            str = jsonDateTimeFormat(value);
        return str;
    }
    function TotalFormatter(value, row, index) {
        var str = "Quotation";
        if (value == "1")
            str = "Agreement";
        return str;
    }
    function OperationQuotaion(value, row, index)
    {
        var str="";
        //if(row.Status==2)
        //{
        //    str ="<a href=\"javascript:void(0)\" onclick='Apporvals(" + JSON.stringify(row) + ",1);'>Agree</a>";
        //    str =str+" | <a href=\"javascript:void(0)\" onclick='Apporvals(" + JSON.stringify(row) + ",3);'>Reject</a>";
        //}
        //else{
            str ="<span style=\"color:gray\">Agree</span>";
           // str =str+" | <span style=\"color:gray\">Reject</span>";
       // }
        return str;
    }
        //这里定义 刚才点击的是哪个协议，哪个项目

    function Apporvals(datarow,ty)
    {

        var msg="";

        if(ty==1)
        {
            msg="Are You Sure Agree This Quotation ?";
        }
        else
        {
            msg="Are You Sure Reject This Quotation ?";
        }
        //发送异步请求
        $.messager.confirm($lang('The System Prompt'),msg,
            function (DeleteSelect) {
                if (DeleteSelect) {
                    $.post("/Project/ApporvalsAction",
                        { Action: "Apporvals", Id: datarow.Id,ProjectId:datarow.ProjectId,Status:ty },
                        function (data, status) {
                            consolelog(status);
                            if (status == "success" && data == "OK") {
                                msgShow($lang('The System Prompt'), $lang('The Operation Successful'), 'info');
                                $("#Quotation_dgrid").datagrid("reload");
                                $("#Quotation_dgrid").datagrid("clearSelections");
                            } else {
                                msgShow($lang('The System Prompt'), $lang('The Operation Failure'), 'error');
                            }
                        });
                }
            });


       // console.log(datarow);
    }


    //明细表
    function QuotationdetailFormatter(index, row) {
        return '<div style="padding:5px"><table id="tbDataAuthorityItemQuotation-' + index + '"></table></div>';
    }
    function Quotationdetail_onExpandRow(index, row){
        //统计值
        var totalprice=0;
        var totalcots=0;
        if(row.AgreeList!=null)
        {
            $.each(row.AgreeList,function(index,value){
                totalprice=totalprice+value.TotalPrice;
                totalcots=totalcots+value.TotalCost;
            });
        }


        $('#tbDataAuthorityItemQuotation-' + index).datagrid({
            data:row.AgreeList,
            singleSelect: true,
            rownumbers: true,
            loadMsg: loadMsg,
            height: 'auto',
            showFooter: true,
            columns: [
                [
                    { field: 'Category',width:100, title: vm_Quotationgridhead.Category },
                    { field: 'Description',width:250, title: vm_Quotationgridhead.Description},
                    { field: 'Uom',width:100, title: vm_Quotationgridhead.Uom },
                    { field: 'Qty',width:50, title: vm_Quotationgridhead.Qty ,align:'right'},
                    { field: 'Cost', width:80,title: vm_Quotationgridhead.Cost,align:'right' },
                    { field: 'TotalCost', width:80,title: vm_Quotationgridhead.TotalCost,align:'right' },
                    { field: 'Price',width:80, title: vm_Quotationgridhead.Price,align:'right' },
                    { field: 'TotalPrice', width:80,title: vm_Quotationgridhead.TotalPrice,align:'right'},
                    { field: 'CostMarkup', width:100,title: vm_Quotationgridhead.CostMarkup,align:'right' }
                ]
            ],
            onResize: function () {
                $('#Quotation_dgrid').datagrid('fixDetailRowHeight', index);
            },
            onLoadSuccess: function () {
                setTimeout(function () {
                    $('#Quotation_dgrid').datagrid('fixDetailRowHeight', index);
                },
                    0);
                //增加尾巴统计
                $(this).datagrid('reloadFooter',
               [
                {Category: "Total", TotalCost: totalcots.toFixed(2),TotalPrice:totalprice.toFixed(2)}
               ]);





            }
        });
        $('#Quotation_dgrid').datagrid('fixDetailRowHeight', index);
    }

    function TotalFormatter(value, row, index){
        //统计值
        var totalprice=0;
        if(row.AgreeList!=null)
        {
            $.each(row.AgreeList,function(index,value){
                totalprice=totalprice+value.TotalPrice;
            });
        }
        return totalprice;

    }



    </script>






</body>






